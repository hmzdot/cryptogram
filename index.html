<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cryptogram Game</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f0f4f8;
        color: #2c3e50;
      }
      h1 {
        color: #34495e;
        text-align: center;
        margin-bottom: 30px;
      }
      .controls {
        text-align: center;
        margin-bottom: 30px;
      }
      .cryptogram {
        margin: 20px 0;
        font-size: 24px;
        letter-spacing: 2px;
        background-color: #ffffff;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        justify-content: center;
        align-items: center;
        text-align: center;
      }
      .word {
        display: flex;
        align-items: center;
        gap: 2px;
        flex-wrap: wrap;
        justify-content: center;
      }
      .word-container {
        display: flex;
        justify-content: center;
        margin: 4px 0;
      }
      .letter {
        display: inline-block;
        text-align: center;
        margin: 0 2px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .punctuation {
        height: 30px;
        line-height: 100%;
        margin-bottom: 5px;
        transform: translateY(-0.5em);
      }
      .hyphen {
        margin-right: 2px;
        color: #666;
      }
      input {
        width: 28px;
        height: 28px;
        text-align: center;
        font-size: 16px;
        margin-bottom: 5px;
        display: block;
        border: 2px solid #bdc3c7;
        border-radius: 5px;
        background-color: #fff;
        transition: all 0.3s ease;
      }
      input:focus {
        outline: none;
        border-color: #95a5a6;
        box-shadow: 0 0 5px rgba(149, 165, 166, 0.5);
      }
      button {
        padding: 12px 24px;
        font-size: 16px;
        /* margin: 10px 5px; */
        border: none;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        background-color: #a8d8ea;
        color: #2c3e50;
      }
      button:hover {
        background-color: #aa96da;
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      button:active {
        transform: translateY(0);
      }
      input[style*="color: red"] {
        background-color: #ffcdd2;
        border-color: #ef9a9a;
      }
      input[style*="color: green"] {
        background-color: #c8e6c9;
        border-color: #a5d6a7;
      }
      input[style*="color: blue"] {
        background-color: #bbdefb;
        border-color: #90caf9;
      }
      .controls {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
      }
      /* Mobile-specific styles */
      @media (max-width: 600px) {
        body {
          padding: 10px;
        }
        h1 {
          font-size: 24px;
          margin-bottom: 20px;
        }
        .cryptogram {
          font-size: 20px;
          padding: 15px;
          gap: 6px;
        }
        input {
          width: 24px;
          height: 24px;
          font-size: 14px;
        }
        button {
          padding: 10px 20px;
          font-size: 14px;
          flex: 1 1 calc(50% - 10px);
          min-width: 120px;
          max-width: 200px;
        }
        .word {
          gap: 1px;
        }
        .letter {
          margin: 0 1px;
        }
      }
    </style>
    <script src="quotes.js"></script>
  </head>
  <body>
    <h1><span id="title">Kriptogram Bulmacası</span></h1>
    <div class="controls">
      <button onclick="newGame()">Yeni Oyun</button>
      <button onclick="checkSolution()">Cevabı Kontrol Et</button>
      <button onclick="giveHint()">İpucu</button>
      <button onclick="revealSolution()">Çözümü Göster</button>
      <button onclick="cleanInputs()">Temizle</button>
    </div>
    <div id="cryptogram" class="cryptogram"></div>

    <script>
      function getQuote() {
        return new Promise(async (resolve) => {
          try {
            // Verify that quotesData exists and contains at least one quote.
            if (!window.quotesData || quotesData.length === 0) {
              throw new Error("No quotes data found.");
            }
            // Optionally, select a random quote rather than always the first one.
            const randomIndex = Math.floor(Math.random() * quotesData.length);
            const englishQuote = quotesData[randomIndex].q;

            // Translate to Turkish using Google Translate API
            const translateResponse = await fetch(
              "https://translate.googleapis.com/translate_a/single",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/x-www-form-urlencoded",
                },
                body: new URLSearchParams({
                  client: "gtx",
                  sl: "en",
                  tl: "tr",
                  dt: "t",
                  q: englishQuote,
                }),
              }
            );

            const translationData = await translateResponse.json();
            const turkishQuote = translationData[0][0][0];
            resolve(turkishQuote);
          } catch (error) {
            const fallbackQuotes = [
              "İnsan ne olduğunu bilmek istiyorsa, önce ne olmadığını görmek zorunda.",
              "Hayat nedir ki,uzun bir ayrılık ezgisinden başka?",
              "Heyhat! Kim açıklayabilir bize insan kalbi neden sevginin yanında nefreti de barındırır?",
              "Büyümek acı çekmek demekmiş, bunu içimi en sızlatan yanımdan öğrenmiştim",
              "Zaman, bize kim olduğumuzu gösterir.",
              "Mücahede kişinin kendisiyle savaşıdır, mücadele başkasıyla. Kendisiyle savaşmayan başkasıyla savaşamaz",
            ];
            console.error("Error fetching or translating quote:", error);
            // Return a random fallback quote.
            resolve(
              fallbackQuotes[Math.floor(Math.random() * fallbackQuotes.length)]
            );
          }
        });
      }

      let currentQuote = "";
      let encryptedQuote = "";
      let solution = {};

      function initSolution() {
        const alphabet = "ABCÇDEFGĞHIİJKLMNOÖPRSŞTUÜVYZ".split("");
        const numbers = Array.from(
          { length: alphabet.length },
          (_, i) => i + 1
        );
        for (let i = numbers.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [numbers[i], numbers[j]] = [numbers[j], numbers[i]];
        }

        const cypher = {};
        solution = {};
        alphabet.forEach((letter, index) => {
          cypher[letter] = numbers[index];
          solution[numbers[index]] = letter;
        });
        return [cypher, solution];
      }

      function encrypt(text, cypher) {
        text = text.toLocaleUpperCase();

        return text
          .split("")
          .map((char) => {
            const encrypted = cypher[char];
            return encrypted ?? char;
          })
          .join(" ");
      }

      function createInput(letter) {
        // Handle spaces and punctuation
        if (!letter.match(/[0-9]/)) {
          const span = document.createElement("span");
          span.className = "punctuation";
          span.innerHTML = letter === " " ? "&nbsp;&nbsp;&nbsp;&nbsp;" : letter;
          return span;
        }
        const span = document.createElement("span");
        span.className = "letter";
        const input = document.createElement("input");
        input.maxLength = 1;
        input.dataset.encrypted = letter;
        input.addEventListener("input", (e) => {
          let value = e.target.value.toLocaleUpperCase();
          e.target.value = value;

          // Fill in all inputs with the same encrypted number
          const sameLetterInputs = document.querySelectorAll(
            `input[data-encrypted="${letter}"]`
          );
          sameLetterInputs.forEach((input) => {
            input.value = value;
          });
        });
        span.appendChild(input);
        const encrypted = document.createElement("span");
        encrypted.textContent = letter;
        span.appendChild(encrypted);
        return span;
      }

      function splitWord(word, maxWidth) {
        // Create a temporary span to measure text width
        const measure = document.createElement("span");
        measure.style.visibility = "hidden";
        measure.style.position = "absolute";
        measure.style.fontSize = "20px"; // Match the mobile font size
        document.body.appendChild(measure);

        // Find the best splitting point (prefer splitting at vowels or consonants)
        const vowels = ["A", "E", "I", "İ", "O", "Ö", "U", "Ü"];
        let bestSplit = Math.floor(word.length / 2);

        // Try to find a vowel near the middle to split at
        for (
          let i = Math.floor(word.length / 2) - 2;
          i < Math.floor(word.length / 2) + 2;
          i++
        ) {
          if (vowels.includes(word[i])) {
            bestSplit = i;
            break;
          }
        }

        const parts = [word.substring(0, bestSplit), word.substring(bestSplit)];

        document.body.removeChild(measure);
        return parts;
      }

      function calculateMaxWordLength() {
        // Calculate the width of a character from header
        // It has "Kriptogram Bulmacası" text so we can calculate the width of
        // a character
        const maxWidth = document.body.clientWidth;
        const charLength = document.querySelector("#title").offsetWidth / 15;
        const maxLength = Math.floor(maxWidth / charLength);
        return maxLength;
      }

      function createWordDiv(word, cypher) {
        const wordDiv = document.createElement("div");
        wordDiv.className = "word";

        const encryptedWord = encrypt(word, cypher);
        const chars = encryptedWord.split(" ");

        // Calculate if we need to split the word
        const maxLength = calculateMaxWordLength();
        if (word.length > maxLength) {
          // Threshold for splitting
          const parts = splitWord(word);
          const firstPart = encrypt(parts[0], cypher).split(" ");
          const secondPart = encrypt(parts[1], cypher).split(" ");

          // Create first part
          firstPart.forEach((char) => {
            wordDiv.appendChild(createInput(char));
          });

          // Add hyphen
          const hyphen = document.createElement("span");
          hyphen.textContent = "-";
          hyphen.className = "hyphen";
          wordDiv.appendChild(hyphen);

          // Force line break
          const lineBreak = document.createElement("div");
          lineBreak.style.flexBasis = "100%";
          lineBreak.style.height = "0";
          wordDiv.appendChild(lineBreak);

          // Create second part
          secondPart.forEach((char) => {
            wordDiv.appendChild(createInput(char));
          });
        } else {
          // Regular word processing
          chars.forEach((char) => {
            wordDiv.appendChild(createInput(char));
          });
        }

        return wordDiv;
      }

      async function newGame() {
        currentQuote = await getQuote();
        const [cypher, solution] = initSolution();
        const container = document.getElementById("cryptogram");
        container.innerHTML = "";

        const words = currentQuote.split(" ");

        words.forEach((word, index) => {
          const wordDiv = createWordDiv(word, cypher);
          container.appendChild(wordDiv);

          // Add space between words
          if (index < words.length - 1) {
            const spaceSpan = document.createElement("span");
            spaceSpan.innerHTML = "&nbsp;&nbsp;";
            container.appendChild(spaceSpan);
          }
        });
      }

      function checkSolution() {
        const inputs = document.querySelectorAll("input");
        let correct = true;

        inputs.forEach((input) => {
          const encrypted = input.dataset.encrypted;
          const userGuess = input.value.toLocaleUpperCase();
          const correctLetter = solution[encrypted];

          if (userGuess !== correctLetter) {
            correct = false;
            input.style.color = "red";
          } else {
            input.style.color = "green";
          }
        });

        if (correct) {
          alert("Tebrikler! Kriptogramı çözdünüz!");
        }
      }

      function revealSolution() {
        const inputs = document.querySelectorAll("input");
        inputs.forEach((input) => {
          const encrypted = input.dataset.encrypted;
          input.value = solution[encrypted];
          input.style.color = "blue";
        });
      }

      function giveHint() {
        const inputs = Array.from(document.querySelectorAll("input"));
        // Filter for empty or incorrect inputs
        const unsolvedInputs = inputs.filter((input) => {
          const encrypted = input.dataset.encrypted;
          const userGuess = input.value.toLocaleUpperCase();
          const correctLetter = solution[encrypted];
          return !userGuess || userGuess !== correctLetter;
        });

        if (unsolvedInputs.length === 0) {
          alert("Tüm harfler zaten çözülmüş!");
          return;
        }

        // Pick a random unsolved input
        const randomInput =
          unsolvedInputs[Math.floor(Math.random() * unsolvedInputs.length)];
        const encrypted = randomInput.dataset.encrypted;
        const correctLetter = solution[encrypted];

        // Fill in all instances of this letter
        const sameLetterInputs = document.querySelectorAll(
          `input[data-encrypted="${encrypted}"]`
        );
        sameLetterInputs.forEach((input) => {
          input.value = correctLetter;
          input.style.color = "blue";
        });
      }

      function cleanInputs() {
        const inputs = document.querySelectorAll("input");
        inputs.forEach((input) => {
          // Only clear inputs that aren't hints (not colored blue)
          if (input.style.color !== "blue") {
            input.value = "";
            input.style.color = ""; // Reset the color
          }
        });
      }

      // Start a new game when the page loads
      window.onload = newGame;
    </script>
  </body>
</html>
