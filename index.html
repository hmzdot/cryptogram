<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cryptogram Game</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f0f4f8;
        color: #2c3e50;
      }
      h1 {
        color: #34495e;
        text-align: center;
        margin-bottom: 30px;
      }
      .controls {
        text-align: center;
        margin-bottom: 30px;
      }
      .cryptogram {
        margin: 20px 0;
        font-size: 24px;
        letter-spacing: 2px;
        background-color: #ffffff;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .word {
        display: flex;
        align-items: center;
        gap: 2px;
      }
      .letter {
        display: inline-block;
        text-align: center;
        margin: 0 2px;
      }
      input {
        width: 30px;
        height: 30px;
        text-align: center;
        font-size: 18px;
        margin-bottom: 5px;
        display: block;
        border: 2px solid #bdc3c7;
        border-radius: 5px;
        background-color: #fff;
        transition: all 0.3s ease;
      }
      input:focus {
        outline: none;
        border-color: #95a5a6;
        box-shadow: 0 0 5px rgba(149, 165, 166, 0.5);
      }
      button {
        padding: 12px 24px;
        font-size: 16px;
        margin: 10px 5px;
        border: none;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        background-color: #a8d8ea;
        color: #2c3e50;
      }
      button:hover {
        background-color: #aa96da;
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }
      button:active {
        transform: translateY(0);
      }
      input[style*="color: red"] {
        background-color: #ffcdd2;
        border-color: #ef9a9a;
      }
      input[style*="color: green"] {
        background-color: #c8e6c9;
        border-color: #a5d6a7;
      }
      input[style*="color: blue"] {
        background-color: #bbdefb;
        border-color: #90caf9;
      }
    </style>
  </head>
  <body>
    <h1>Kriptogram Bulmacası</h1>
    <div class="controls">
      <button onclick="newGame()">Yeni Oyun</button>
      <button onclick="checkSolution()">Cevabı Kontrol Et</button>
      <button onclick="giveHint()">İpucu</button>
      <button onclick="revealSolution()">Çözümü Göster</button>
    </div>
    <div id="cryptogram" class="cryptogram"></div>

    <script>
      async function getQuote() {
        const apiUrl =
          "https://mcanvar.github.io/gibi-sayings/v1.0.0/sayings.json";

        /**
         * @typedef {{
         *  saying: string;
         *  season: number;
         *  episode: number;
         *  episodeName: string;
         *  saidAt: string;
         *  saidBy: string;
         * }} Saying
         *
         * @typedef {Saying[]} ApiResponse
         */

        const response = await fetch(apiUrl);

        /** @type {ApiResponse} */
        const data = await response.json();

        // Select a random saying
        const randomIndex = Math.floor(Math.random() * data.length);
        const randomSaying = data[randomIndex];

        return randomSaying.saying;
      }

      let currentQuote = "";
      let encryptedQuote = "";
      let solution = {};

      function initSolution() {
        const alphabet = "ABCÇDEFGĞHIİJKLMNOÖPRSŞTUÜVYZ".split("");
        const numbers = Array.from(
          { length: alphabet.length },
          (_, i) => i + 1
        );
        for (let i = numbers.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [numbers[i], numbers[j]] = [numbers[j], numbers[i]];
        }

        const cypher = {};
        solution = {};
        alphabet.forEach((letter, index) => {
          cypher[letter] = numbers[index];
          solution[numbers[index]] = letter;
        });
        return [cypher, solution];
      }

      function encrypt(text, cypher) {
        text = text.toUpperCase();

        return text
          .split("")
          .map((char) => {
            const encrypted = cypher[char];
            return encrypted ?? char;
          })
          .join(" ");
      }

      function createInput(letter) {
        // Handle spaces and punctuation
        if (!letter.match(/[0-9]/)) {
          const span = document.createElement("span");
          span.innerHTML = letter === " " ? "&nbsp;&nbsp;&nbsp;&nbsp;" : letter;
          return span;
        }
        const span = document.createElement("span");
        span.className = "letter";
        const input = document.createElement("input");
        input.maxLength = 1;
        input.dataset.encrypted = letter;
        input.addEventListener("input", (e) => {
          let value = e.target.value.toUpperCase();
          // Convert similar looking letters to Turkish characters
          value = value.replace(/I/g, "İ");
          value = value.replace(/i/g, "ı");
          e.target.value = value;

          // Fill in all inputs with the same encrypted number
          const sameLetterInputs = document.querySelectorAll(
            `input[data-encrypted="${letter}"]`
          );
          sameLetterInputs.forEach((input) => {
            input.value = value;
          });
        });
        span.appendChild(input);
        const encrypted = document.createElement("span");
        encrypted.textContent = letter;
        span.appendChild(encrypted);
        return span;
      }

      async function newGame() {
        currentQuote = await getQuote();
        const [cypher, solution] = initSolution();
        const container = document.getElementById("cryptogram");
        container.innerHTML = "";

        const words = currentQuote.split(" ");
        const encryptedWords = words.map((word) => encrypt(word, cypher));

        words.forEach((_, index) => {
          const wordDiv = document.createElement("div");
          wordDiv.className = "word";

          const encryptedWord = encryptedWords[index];
          if (!encryptedWord) {
            wordDiv.appendChild(createInput(" "));
          } else {
            // Process each character in the encrypted word
            encryptedWord.split(" ").forEach((char) => {
              wordDiv.appendChild(createInput(char));
            });
          }

          // Add space after each word except the last one
          if (index < words.length - 1) {
            const spaceSpan = document.createElement("span");
            spaceSpan.innerHTML = "&nbsp;&nbsp;";
            container.appendChild(wordDiv);
            container.appendChild(spaceSpan);
          } else {
            container.appendChild(wordDiv);
          }
        });
      }

      function checkSolution() {
        const inputs = document.querySelectorAll("input");
        let correct = true;

        inputs.forEach((input) => {
          const encrypted = input.dataset.encrypted;
          const userGuess = input.value.toUpperCase();
          const correctLetter = solution[encrypted];

          if (userGuess !== correctLetter) {
            correct = false;
            input.style.color = "red";
          } else {
            input.style.color = "green";
          }
        });

        if (correct) {
          alert("Tebrikler! Kriptogramı çözdünüz!");
        }
      }

      function revealSolution() {
        const inputs = document.querySelectorAll("input");
        inputs.forEach((input) => {
          const encrypted = input.dataset.encrypted;
          input.value = solution[encrypted];
          input.style.color = "blue";
        });
      }

      function giveHint() {
        const inputs = Array.from(document.querySelectorAll("input"));
        // Filter for empty or incorrect inputs
        const unsolvedInputs = inputs.filter((input) => {
          const encrypted = input.dataset.encrypted;
          const userGuess = input.value.toUpperCase();
          const correctLetter = solution[encrypted];
          return !userGuess || userGuess !== correctLetter;
        });

        if (unsolvedInputs.length === 0) {
          alert("Tüm harfler zaten çözülmüş!");
          return;
        }

        // Pick a random unsolved input
        const randomInput =
          unsolvedInputs[Math.floor(Math.random() * unsolvedInputs.length)];
        const encrypted = randomInput.dataset.encrypted;
        const correctLetter = solution[encrypted];

        // Fill in all instances of this letter
        const sameLetterInputs = document.querySelectorAll(
          `input[data-encrypted="${encrypted}"]`
        );
        sameLetterInputs.forEach((input) => {
          input.value = correctLetter;
          input.style.color = "blue";
        });
      }

      // Start a new game when the page loads
      window.onload = newGame;
    </script>
  </body>
</html>
